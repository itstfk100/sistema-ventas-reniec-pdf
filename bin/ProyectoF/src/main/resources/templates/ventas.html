<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrar Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            border: 1px solid #ced4da;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .autocomplete-results.show {
            display: block;
        }
        .autocomplete-results .list-group-item {
            cursor: pointer;
        }
        .autocomplete-results .list-group-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-cart-fill"></i> Registro de Venta
        </a>
        <a id="cerrarSesionBtn" href="#" class="btn btn-outline-light">Cerrar sesión</a>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="text-center text-primary mb-4">Registrar Venta</h2>

    <form id="formVenta" action="/ventas/registrar" method="POST">
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label">Cód. de venta:</label>
                <input type="text" id="codigoVenta" name="codigoBoleta" class="form-control" th:value="${codigoBoleta}" readonly>
            </div>
            <div class="col-md-4">
                <label class="form-label">Cliente (Opcional):</label>
                <input type="text" id="cliente" name="cliente" class="form-control" placeholder="Nombre del cliente">
            </div>
            <div class="col-md-4">
                <label class="form-label">Fecha:</label>
                <input type="date" id="fecha" name="fecha" class="form-control" required>
            </div>
        </div>

        <hr>
        <h4 class="mb-3">Detalle de la venta</h4>

        <div class="row g-2 mb-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label">Buscar producto por nombre o código:</label>
                <div class="autocomplete-container">
                    <input type="text" id="busquedaProducto" class="form-control" placeholder="Escribe para buscar...">
                    <div id="resultadoBusqueda" class="autocomplete-results list-group"></div>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Stock:</label>
                <input type="number" id="stockDisponible" class="form-control" readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label">Precio Unit.:</label>
                <input type="number" id="precioUnitario" class="form-control" readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cantidad:</label>
                <input type="number" id="cantidad" class="form-control" min="1" value="1">
            </div>
            <div class="col-md-1 d-grid">
                <button class="btn btn-success" type="button" onclick="agregarProducto()">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
        </div>

        <div class="table-responsive mb-3">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody id="tablaProductos">
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <div><strong id="totalProductos">Total de 0 productos registrados</strong></div>
            <div><strong id="totalVenta">Total Venta: S/ 0.00</strong></div>
        </div>

        <div class="text-end">
            <button class="btn btn-warning me-2 text-white" type="button" onclick="vaciarFormulario()">Vaciar</button>
            <button class="btn btn-success" type="button" onclick="confirmarVenta()">Confirmar venta</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let productosCarrito = [];
    let productoSeleccionadoId = null;

    const busquedaProductoInput = document.getElementById('busquedaProducto');
    const resultadoBusquedaDiv = document.getElementById('resultadoBusqueda');

    busquedaProductoInput.addEventListener('input', function() {
        const query = this.value.trim();
        resultadoBusquedaDiv.innerHTML = '';
        if (query.length < 2) {
            resultadoBusquedaDiv.classList.remove('show');
            return;
        }

        fetch(`/api/productos/buscar?query=${query}`)
            .then(response => response.json())
            .then(productos => {
                if (productos.length === 0) {
                    resultadoBusquedaDiv.innerHTML = '<div class="list-group-item">No se encontraron productos.</div>';
                } else {
                    productos.forEach(p => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${p.nombre}</strong> <small>(Cód: ${p.id}) - Stock: ${p.stock}</small>`;

                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            seleccionarProducto(p);
                        });
                        resultadoBusquedaDiv.appendChild(item);
                    });
                }
                resultadoBusquedaDiv.classList.add('show');
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                resultadoBusquedaDiv.innerHTML = '<div class="list-group-item text-danger">Error de conexión.</div>';
                resultadoBusquedaDiv.classList.add('show');
            });
    });

    document.addEventListener('click', function(event) {
        if (!busquedaProductoInput.contains(event.target) && !resultadoBusquedaDiv.contains(event.target)) {
            resultadoBusquedaDiv.classList.remove('show');
        }
    });

    function seleccionarProducto(producto) {
        productoSeleccionadoId = producto.id;
        busquedaProductoInput.value = producto.nombre;
        document.getElementById('stockDisponible').value = producto.stock;
        document.getElementById('precioUnitario').value = producto.precioVenta.toFixed(2);
        document.getElementById('cantidad').max = producto.stock;
        document.getElementById('cantidad').value = 1;
        resultadoBusquedaDiv.classList.remove('show');
    }

    function agregarProducto() {
        const cantidad = parseInt(document.getElementById('cantidad').value);
        const stock = parseInt(document.getElementById('stockDisponible').value);
        const precioUnitario = parseFloat(document.getElementById('precioUnitario').value);


        if (!productoSeleccionadoId) {
            Swal.fire('Error', 'Debe seleccionar un producto de la lista desplegable.', 'error');
            return;
        }

        if (cantidad <= 0 || isNaN(cantidad)) {
            Swal.fire('Error', 'La cantidad debe ser un número positivo.', 'error');
            return;
        }

        if (cantidad > stock) {
            Swal.fire('Error', `La cantidad solicitada supera el stock disponible (${stock}).`, 'error');
            return;
        }

        if (isNaN(precioUnitario) || precioUnitario <= 0) {
            Swal.fire('Error', 'El producto seleccionado no tiene un precio unitario válido.', 'error');
            return;
        }

        const productoExistente = productosCarrito.find(p => p.productoId === productoSeleccionadoId);

        if (productoExistente) {
            if (productoExistente.cantidad + cantidad > stock) {
                Swal.fire('Error', `La cantidad total del producto (${productoExistente.cantidad + cantidad}) supera el stock.`, 'error');
                return;
            }
            productoExistente.cantidad += cantidad;
            productoExistente.subtotal = productoExistente.cantidad * productoExistente.precioUnitario;
        } else {
            const nombre = busquedaProductoInput.value;
            productosCarrito.push({
                productoId: productoSeleccionadoId,
                nombre: nombre,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                subtotal: cantidad * precioUnitario
            });
        }

        limpiarFormularioProducto();
        actualizarTabla();
    }

    function eliminarProducto(index) {
        productosCarrito.splice(index, 1);
        actualizarTabla();
    }

    function actualizarTabla() {
        const tbody = document.getElementById('tablaProductos');
        tbody.innerHTML = '';
        let totalVenta = 0;

        productosCarrito.forEach((p, index) => {
            const row = `
                <tr>
                    <td>${p.productoId}</td>
                    <td>${p.nombre}</td>
                    <td>${p.cantidad}</td>
                    <td>S/ ${p.precioUnitario.toFixed(2)}</td>
                    <td>S/ ${p.subtotal.toFixed(2)}</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">
                        <i class="bi bi-trash"></i>
                    </button></td>
                </tr>
            `;
            tbody.innerHTML += row;
            totalVenta += p.subtotal;
        });

        document.getElementById('totalProductos').innerText = `Total de ${productosCarrito.length} productos en el carrito`;
        document.getElementById('totalVenta').innerText = `Total Venta: S/ ${totalVenta.toFixed(2)}`;
    }

    function limpiarFormularioProducto() {
        busquedaProductoInput.value = '';
        document.getElementById('cantidad').value = 1;
        document.getElementById('stockDisponible').value = '';
        document.getElementById('precioUnitario').value = '';
        document.getElementById('cantidad').max = '';
        resultadoBusquedaDiv.classList.remove('show');
        productoSeleccionadoId = null;
    }

    function vaciarFormulario() {
        productosCarrito = [];
        limpiarFormularioProducto();
        actualizarTabla();
        document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('cliente').value = '';
    }

    function confirmarVenta() {
        const codigoBoleta = document.getElementById('codigoVenta').value;
        const fecha = document.getElementById('fecha').value;
        const total = parseFloat(document.getElementById('totalVenta').innerText.replace('Total Venta: S/ ', ''));

        if (!fecha) {
            Swal.fire('Error', 'Por favor, ingrese la fecha de la venta.', 'error');
            return;
        }

        if (productosCarrito.length === 0) {
            Swal.fire('Error', 'Debe agregar al menos un producto a la venta.', 'error');
            return;
        }

        const ventaData = {
            codigoBoleta: codigoBoleta,
            fecha: fecha,
            total: total,
            detalles: productosCarrito.map(p => ({
                productoId: p.productoId,
                cantidad: p.cantidad,
                precioUnitario: p.precioUnitario,
                subtotal: p.subtotal
            }))
        };

        fetch('/ventas/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(ventaData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Error desconocido en el servidor');
                    });
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Venta registrada con éxito',
                    html: `Código de venta: <strong>${data.codigoBoleta}</strong><br><br>¿Qué desea hacer a continuación?`,
                    showCancelButton: true,
                    confirmButtonText: 'Registrar nueva venta',
                    cancelButtonText: 'Descargar Boleta PDF',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#0d6efd'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload(); // Recargar la página para una nueva venta
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        const pdfUrl = `/ventas/generarBoletaPdf/${data.id}`;
                        window.open(pdfUrl, '_blank');
                        window.location.reload(); // CAMBIO: Recargar la página después de abrir el PDF
                    }
                });
            })
            .catch(error => {
                console.error('Error al registrar la venta:', error);
                Swal.fire('Error', 'Hubo un problema al registrar la venta: ' + error.message, 'error');
            });
    }

    document.getElementById('cerrarSesionBtn').addEventListener('click', function(event) {
        event.preventDefault();
        window.location.href = '/logout';
    });

    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
    };

</script>
</body>
</html>
